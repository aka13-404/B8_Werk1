[gcode_macro prepare_bed]
gcode:
	G28
	_CONNECT_PROBE_PHASE_I
	Z_TILT_ADJUST
	CALIBRATE_Z

[gcode_macro accel_test]
gcode:
	SET_VELOCITY_LIMIT ACCEL=500										#safe 500 mmsec accel
	{% if printer.toolhead.homed_axes == "" %}
		G28
	{% endif %}
	_DISCONNECT_PROBE_PHASE_I
	G90
	G1 Z50 F12000
	G1 X{ printer.toolhead.axis_minimum.x } Y{ printer.toolhead.axis_minimum.y } F6000
	{% for acceleration in (3000, 4000, 5000, 6000, 7000, 8000, 9000, 10000) %}
		SET_VELOCITY_LIMIT ACCEL={ acceleration } ACCEL_TO_DECEL={ acceleration/2 }
		RESPOND MSG="ACCEL={ acceleration } ACCEL_TO_DECEL={ acceleration/2 } "
		G1 X{ printer.toolhead.axis_maximum.x } Y{ printer.toolhead.axis_maximum.y } F30000 #diagonal move to endstops
		G1 X{ printer.toolhead.axis_maximum.x } Y{ printer.toolhead.axis_minimum.y } F30000 #square move bottom right
		G1 X{ printer.toolhead.axis_minimum.x } Y{ printer.toolhead.axis_minimum.y } F30000	#square move bottom left
		G1 X{ printer.toolhead.axis_minimum.x } Y{ printer.toolhead.axis_maximum.y } F30000	#square move top left
		G1 X{ printer.toolhead.axis_maximum.x } Y{ printer.toolhead.axis_maximum.y } F30000 #square move top right
		G1 X{ printer.toolhead.axis_minimum.x } Y{ printer.toolhead.axis_minimum.y } F30000 #diagonal move to initial position
	{% endfor %}


#########################################
###         FILAMENT MACROS           ###
#########################################


[gcode_macro FILAMENT_EJECT]
gcode:
	M109 S220
	M83
	G1 E-200 F500
	RESPOND PREFIX=tgalarm MSG="Filament ejected"
	M104 S0

[gcode_macro FILAMENT_INSERT_PREHEAT]
gcode:
	M109 S250
	RESPOND PREFIX=tgalarm MSG="Preheated, insert filament, run "
	G4 P1000
	RESPOND PREFIX=tgnotify MSG="/FILAMENT_INSERT"

[gcode_macro FILAMENT_INSERT]
gcode:
	M109 S250
	M83
	G1 E100 F250
	M104 S0



[gcode_macro DEBUG]
gcode:
	{% if (printer.toolhead.position.z + 10) <= printer.configfile.settings.stepper_z.position_max %}
		#Check if we have space to move table down 10mm
		RESPOND MSG="G1 Z{ printer.toolhead.position.z + 10 } F{ printer.configfile.settings.printer.max_z_velocity * 60 }"
	{% else %}
		RESPOND MSG="G1 Z{ printer.configfile.settings.stepper_z.position_max } F{ printer.configfile.settings.printer.max_z_velocity * 60 }"
	{% endif %}
